<script src="/sources/js/plugins/swiper/swiper-bundle.min.js"></script>
<script src="/sources/js/plugins/three/three.min.js"></script>
<script src="/sources/js/plugins/gsap/gsap.min.js"></script>
<script src="/sources/js/plugins/videojs/video.js"></script>
<script src="/sources/js/plugins/videojs/youtube.js"></script>
<script src="/sources/js/plugins/instafeed/instafeed.js"></script>
<script src="/sources/js/plugins/lottie/lottie.js"></script>
<script src="/sources/js/plugins/mobile-detect/mobile-detect.js"></script>
<script src="/sources/js/plugins/datepicker/datepicker.min.js"></script>
<script src="/sources/js/bundle.js"></script>
<script>
  window.jStoreConfig = {
    'restaurant': 'fe470000-906b-0025-7534-08d8def3c45b',
    'templates': [
      {
        'type': 'itemPopUp',
        'template': '#itemPopUp'
      },
      {
        'type': 'itemsFilter',
        'properties': {
          'categories': [
            "2f20ca32-939c-43bf-bb33-2ff6849b85b8"//выводим конкретную категорию
          ]
        }
      },
      {
        'type': 'itemsFilter#custom-block->catalogItem',
        'class': 'page-toppings',
        'template': '#custom-block-item-template'//кастомизируем ещё и элементы блока
      }
    ]
  }
</script>
<script data-main="https://deliverywiget.iiko.ru/v2_0/app/config" src="https://deliverywiget.iiko.ru/v2_0/libs/require.js"></script>
<script id='itemPopUp' type='text/template'>
	<main class="main main--dish container">
    <section class="main__dish dish">
      <div class="dish__box">
        <header class="dish__header">
          <button class="dish__back-link lsp-js-popup-close">Вернуться в меню</button>
          <ul class="dish__features">
            <% if(tags.length){ %>
              <% _.each(tags, function(tag){ %>
                <li class="dish__feature">
                  <div class="dish__icon dish__icon--<%= tag.translitName %>" aria-label="<%= tag.name %>" title="<%= tag.name %>"></div>
                </li>
              <% }); %>
            <% } %>
          </ul>
          <h1 class="dish__title" data-jstore-value="name"></h1>
        </header>
        <p class="dish__text" data-jstore-value="description"></p>
        <dl class="dish__description-list">
          <div class="dish__desc-wrap">
            <dt class="dish_terms">Kcal</dt>
            <dt class="dish__desc" data-jstore-value="energyAmount"></dt>
          </div>
          <div class="dish__desc-wrap">
            <dt class="dish_terms">Б</dt>
            <dt class="dish__desc" data-jstore-value="fiberAmount"></dt>
          </div>
          <div class="dish__desc-wrap">
            <dt class="dish_terms">Ж</dt>
            <dt class="dish__desc" data-jstore-value="fatAmount"></dt>
          </div>
          <div class="dish__desc-wrap">
            <dt class="dish_terms">У</dt>
            <dt class="dish__desc" data-jstore-value="carbohydrateAmount"></dt>
          </div>
        </dl>
        <div class="dish__inner">
          <p class="dish__price"><span data-jstore-value="jStoreApp.fixMath(count * cost)"></span><span class="rouble">&nbsp;a</span></p>
          <button class="dish__button link-reserv link-reserv--order">Заказать</button>
        </div>
        <div class="dish__inner">
          <div class="dish__count-box">
            <button class="dish__count-btn lsp-js-popup-item-minus">
              <img src="/img/pages/dish/icon-minus.svg" width="10" height="2" alt="Минус">
            </button>
            <label for="count" class="visually-hidden">Количество</label>
            <input type="number" id="count" name="count" class="dish__count lsp-js-popup-total-count" data-jstore-value="count">
            <button class="dish__count-btn lsp-js-popup-item-plus">
              <img src="/img/pages/dish/icon-plus.svg" width="10" height="10" alt="Плюс">
            </button>
          </div>
        </div>
        <div class="dish__wrapper">
          <img data-jstore-src="largeImageUrl" width="414" height="530" alt="<%= name %>" class="dish__img below-tablet">
          <div class="dish__gradient below-tablet"></div>
        </div>
      </div>
      <div class="dish__img-box above-tablet">
        <!-- <p class="dish__badge dish__badge--cheef">Выбор шеф-повара</p> -->
        <img data-jstore-src="largeImageUrl" width="454" height="696" alt="<%= name %>" class="dish__img">
        <div class="dish__gradient"></div>
      </div>
    </section>
    <aside class="main__other-dish other-dish">
      <h2 class="other-dish__title">Другие блюда раздела Гриль</h2>
      <div class="other-dish__wrapper">
        <ul class="other-dish__list js-other-dishes">
        </ul>
      </div>
    </aside>
  </main>
</script>

<script type="text/html" id="custom-block-item-template">
  <div class="js-menu-add-item">
      <a href="<%= url %>" class="js-menu-add-link"><%= name %></a>
      <div class="lsp-block-item-price">
        <span class="js-menu-add-price"
            data-jstore-value="cost"><%= cost %></span>
      </div>
      <img class="js-menu-add-img" title="<%= name %>"
        data-jstore-src="mediumImageUrl">
  </div>
</script>
<script>
  const mapElement = document.querySelector(`#map`);
  let map;

  let infoWindows = [];

  const Locations = [
    {
      location: { lat: 59.934, lng: 30.333 },
      title: `Невский пр. 48`,
      img: `/img/pages/contacts/contacts-1.jpg`
    },
    {
      location: { lat: 59.852, lng: 30.147 },
      title: `ул. Адмирала Трибуца 6`,
      img: `/img/pages/contacts/contacts-1.jpg`
    },
    {
      location: { lat: 59.945, lng: 30.286 },
      title: `Кадетская линия В.О. 25`,
      img: `/img/pages/contacts/contacts-1.jpg`
    },
  ];

  const MapCenters = {
    FOOTER: { lat: 59.910, lng: 30.237 },
    OTHER: { lat: 59.897, lng: 30.171 },
    MOBILE: { lat: 59.925, lng: 30.251 }
  };

  const MapZooms = {
    FOOTER: 11,
    OTHER: 12,
    MOBILE: 10
  }

  const isMobile = window.matchMedia("(max-width: 767px)").matches

  const getZoomValue = () => {
    if (mapElement.classList.contains(`isPayDelivery`) && isMobile) {
      return MapZooms.MOBILE
    }

    return MapZooms.FOOTER
  }

  const getLocationValue = () => {
    if (mapElement.classList.contains(`isFooterMap`)) {
      return MapCenters.FOOTER
    }

    if (mapElement.classList.contains(`isPayDelivery`) && isMobile) {
      return MapCenters.MOBILE
    }

    return MapCenters.OTHER
  }

  function initMap() {
    if (mapElement) {
      map = new google.maps.Map(mapElement, {
        center: getLocationValue(),
        zoom: getZoomValue(),
        mapId: 'd42291912907a704',
        disableDefaultUI: true,
      });

      console.log(mapElement.classList.contains(`isFooterMap`));
      console.log(map.zoom);

      const getContentTemplate = (title, imgUrl) => {
        return `
        <div class="contacts-page__card">
          <div class="contacts-page__img-box">
            <img src="${imgUrl}" width="120" height="110" alt="Ресторан на ${title}"
              class="contacts-page__img">
          </div>
          <div class="contacts-page__adress-box">
            <p class="contacts-page__adress">
              ${title}
            </p>
            <a href="tel:+78124078000 " class="contacts__phone">+7 (812) 407-80-00</a>
          </div>
        </div>
      `};

      const createInfoWindow = (title, imgUrl) => {
        return new google.maps.InfoWindow({
          content: getContentTemplate(title, imgUrl),
        });
      };

      const directionsDisplay = new google.maps.DirectionsRenderer({
        suppressInfoWindows: true,
        map: map
      });

      const markers = Locations.map(({ location, title, img }, index) => {
        const marker = new google.maps.Marker({
          position: location,
          icon: `/img/common/icon-dot-test.svg`,
          title: `${title}`,
          map,
        });

        const infowindow = createInfoWindow(title, img);

        marker.addListener("click", () => {
          infowindow.open(map, marker);
        });

        map.addListener("click", () => {
          infowindow.close(map, marker);
        });

        marker.addListener("mouseover", () => {
          infowindow.open(map, marker);
        });

        marker.addListener("mouseout", () => {
          infowindow.close(map, marker);
        });

        infoWindows = [...infoWindows, infowindow]

        return marker;
      });

      if (mapElement.classList.contains(`isContactsPage`)) {
        let index = 0;
        let length = markers.length;

        const getPreviusIndex = () => index - 1 === -1 ? markers.length - 1 : index - 1;

        const doNext = () => {
          let entry = markers[index];

          infoWindows[getPreviusIndex()].close(map, markers[getPreviusIndex()]);
          infoWindows[index].open(map, markers[index]);

          index++;

          if (index < markers.length) {
          } else {
            index = 0;
          }
          setTimeout(doNext, 2000);
        };

        doNext();
      }
    }
  }
</script>
<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBF0i_XK-OZ-FhghtyTfelWk9I25ZtS-MQ&callback=initMap"></script>
